<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×“×©×‘×•×¨×“ ×—×™×™×©× ×™× - Tuya</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×—×™×™×©× ×™ ×”×‘×™×ª">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ </text></svg>">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            /* Light Mode (Day) */
            --bg-primary: linear-gradient(135deg, #e8f4f8 0%, #d4e8ed 50%, #c1dce6 100%);
            --bg-card: rgba(255, 255, 255, 0.8);
            --bg-card-hover: rgba(255, 255, 255, 0.95);
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --accent-color: #d4a017;
            --accent-glow: rgba(212, 160, 23, 0.3);
            --border-color: rgba(0, 0, 0, 0.1);
            --chart-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            
            /* Responsive sizing */
            --gauge-size: min(40vw, 200px);
            --font-title: clamp(1.2rem, 4vw, 2.5rem);
            --font-value: clamp(1.5rem, 5vw, 2.5rem);
            --font-normal: clamp(0.75rem, 2vw, 1rem);
            --font-small: clamp(0.65rem, 1.5vw, 0.85rem);
            --padding-card: clamp(10px, 2vw, 25px);
            --gap-size: clamp(10px, 2vw, 30px);
        }

        [data-theme="dark"] {
            /* Dark Mode (Night) */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #e6e6e6;
            --text-muted: #8892b0;
            --accent-color: #ffd700;
            --accent-glow: rgba(255, 215, 0, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
            --chart-bg: rgba(0, 0, 0, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: var(--bg-primary);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            color: var(--text-primary);
            padding: clamp(8px, 2vw, 20px);
            transition: background 0.5s ease, color 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: clamp(15px, 3vw, 30px);
        }

        .header h1 {
            font-size: var(--font-title);
            color: var(--accent-color);
            text-shadow: 0 0 20px var(--accent-glow);
        }

        .header .datetime {
            font-size: var(--font-small);
            color: var(--text-muted);
            margin-top: clamp(5px, 1vw, 10px);
        }

        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(5px, 1.5vw, 15px);
            margin-top: clamp(8px, 1.5vw, 15px);
            flex-wrap: wrap;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: clamp(4px, 1vw, 8px);
            padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.5vw, 15px);
            background: var(--bg-card);
            border-radius: 20px;
            font-size: var(--font-small);
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-dot.warning {
            background: #ff9800;
        }

        .status-dot.error {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: clamp(4px, 1vw, 8px);
            padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.5vw, 15px);
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: var(--font-small);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-card-hover);
        }

        .theme-icon {
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
        }

        #themeText {
            display: none;
        }

        @media (min-width: 500px) {
            #themeText {
                display: inline;
            }
        }

        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: clamp(8px, 2vw, 15px) clamp(10px, 2vw, 20px);
            background: linear-gradient(90deg, #f44336, #e91e63);
            color: white;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(8px, 2vw, 15px);
            font-size: var(--font-small);
        }

        .alert-banner.active {
            transform: translateY(0);
        }

        .alert-banner .close-alert {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.5vw, 15px);
            border-radius: 20px;
            cursor: pointer;
            font-size: var(--font-small);
        }

        /* Alerts Panel */
        .alerts-panel {
            position: fixed;
            top: clamp(60px, 12vw, 80px);
            left: clamp(10px, 2vw, 20px);
            right: clamp(10px, 2vw, 20px);
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: clamp(10px, 2vw, 15px);
            border: 1px solid var(--border-color);
            max-width: 350px;
            max-height: 50vh;
            overflow-y: auto;
            display: none;
            z-index: 999;
            box-shadow: 0 10px 40px var(--shadow-color);
        }

        .alerts-panel.active {
            display: block;
        }

        .alerts-panel h3 {
            color: var(--accent-color);
            margin-bottom: clamp(6px, 1.5vw, 10px);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-normal);
        }

        .alert-item {
            padding: clamp(6px, 1.5vw, 10px);
            margin-bottom: clamp(5px, 1vw, 8px);
            border-radius: 8px;
            font-size: var(--font-small);
        }

        .alert-item.warning {
            background: rgba(255, 152, 0, 0.2);
            border-right: 3px solid #ff9800;
        }

        .alert-item.danger {
            background: rgba(244, 67, 54, 0.2);
            border-right: 3px solid #f44336;
        }

        .alert-item.info {
            background: rgba(33, 150, 243, 0.2);
            border-right: 3px solid #2196f3;
        }

        .alert-time {
            font-size: clamp(0.55rem, 1.2vw, 0.7rem);
            color: var(--text-muted);
            margin-top: clamp(3px, 0.5vw, 5px);
        }

        .alerts-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: clamp(4px, 1vw, 8px);
            padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.5vw, 15px);
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: var(--font-small);
            color: var(--text-primary);
        }

        .alerts-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            font-size: clamp(0.55rem, 1.2vw, 0.7rem);
            padding: 2px 5px;
            border-radius: 10px;
            display: none;
        }

        .alerts-badge.active {
            display: block;
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-size);
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
        }

        /* Large tablets and desktops */
        @media (min-width: 1024px) {
            .dashboard {
                max-width: 1200px;
            }
        }

        /* Small tablets - 2 columns */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: clamp(8px, 2vw, 15px);
            }
        }

        /* Mobile phones - 2 columns but smaller */
        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }

        /* Very small screens - still 2 columns */
        @media (max-width: 360px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
        }

        .sensor-card {
            background: var(--bg-card);
            border-radius: clamp(10px, 2vw, 20px);
            padding: var(--padding-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            position: relative;
            min-width: 0; /* Prevent overflow */
        }

        .sensor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--shadow-color);
            background: var(--bg-card-hover);
        }

        .sensor-card.alert {
            border: 2px solid #f44336;
            animation: alertPulse 1s ease infinite;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(244, 67, 54, 0.2); }
        }

        .sensor-card.warning {
            border: 2px solid #ff9800;
        }

        .alert-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            display: none;
        }

        .sensor-card.alert .alert-indicator,
        .sensor-card.warning .alert-indicator {
            display: block;
        }

        .sensor-title {
            text-align: center;
            font-size: var(--font-normal);
            margin-bottom: clamp(8px, 2vw, 20px);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sensor-icon {
            font-size: clamp(1rem, 3vw, 1.5rem);
            margin-left: clamp(3px, 1vw, 10px);
        }

        .gauge-container {
            position: relative;
            width: var(--gauge-size);
            height: var(--gauge-size);
            margin: 0 auto;
            max-width: 100%;
        }

        .gauge-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .gauge-bg {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 10;
        }

        .gauge-progress {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .gauge-progress.gas { stroke: url(#gasGradient); }
        .gauge-progress.water { stroke: url(#waterGradient); }
        .gauge-progress.electricity { stroke: url(#electricityGradient); }
        .gauge-progress.temperature { stroke: url(#temperatureGradient); }

        .gauge-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 80%;
        }

        .current-value {
            font-size: var(--font-value);
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 0 0 15px var(--accent-glow);
            line-height: 1.1;
        }

        .unit {
            font-size: var(--font-small);
            color: var(--text-muted);
        }

        .history-section {
            margin-top: clamp(8px, 2vw, 20px);
            padding-top: clamp(8px, 1.5vw, 15px);
            border-top: 1px solid var(--border-color);
        }

        .history-title {
            font-size: var(--font-small);
            color: var(--text-muted);
            margin-bottom: clamp(4px, 1vw, 10px);
            text-align: center;
        }

        .history-value {
            font-size: clamp(1rem, 4vw, 1.8rem);
            font-weight: bold;
            text-align: center;
            color: #64ffda;
        }

        .history-progress {
            margin-top: clamp(5px, 1vw, 10px);
            background: var(--border-color);
            border-radius: 10px;
            height: clamp(4px, 1vw, 8px);
            overflow: hidden;
        }

        .history-progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .history-progress-bar.gas { background: linear-gradient(90deg, #ff6b6b, #ffa06b); }
        .history-progress-bar.water { background: linear-gradient(90deg, #4facfe, #00f2fe); }
        .history-progress-bar.electricity { background: linear-gradient(90deg, #f9d423, #ff4e50); }
        .history-progress-bar.temperature { background: linear-gradient(90deg, #667eea, #764ba2); }

        .target-info {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.55rem, 1.5vw, 0.8rem);
            color: var(--text-muted);
            margin-top: clamp(3px, 0.5vw, 5px);
        }

        .footer {
            text-align: center;
            margin-top: clamp(15px, 3vw, 30px);
            padding: clamp(10px, 2vw, 20px);
            color: var(--text-muted);
            font-size: var(--font-small);
        }

        .last-update {
            font-size: clamp(0.55rem, 1.3vw, 0.8rem);
            color: var(--text-muted);
            text-align: center;
            margin-top: clamp(5px, 1vw, 10px);
        }

        /* Advanced Charts Section */
        .charts-section {
            margin-top: clamp(15px, 3vw, 30px);
            background: var(--bg-card);
            border-radius: clamp(10px, 2vw, 20px);
            padding: var(--padding-card);
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border-color);
        }

        .charts-section h2 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: clamp(10px, 2vw, 20px);
            font-size: clamp(1rem, 3vw, 1.5rem);
        }

        .chart-tabs {
            display: flex;
            justify-content: center;
            gap: clamp(4px, 1vw, 10px);
            margin-bottom: clamp(10px, 2vw, 20px);
            flex-wrap: wrap;
        }

        .chart-tab {
            padding: clamp(4px, 1vw, 8px) clamp(8px, 2vw, 20px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-small);
        }

        .chart-tab:hover, .chart-tab.active {
            background: var(--accent-color);
            color: #1a1a2e;
            border-color: var(--accent-color);
        }

        .chart-wrapper {
            display: none;
            height: clamp(150px, 30vh, 300px);
            padding: clamp(5px, 1vw, 10px);
        }

        .chart-wrapper.active {
            display: block;
        }

        .chart-period-selector {
            display: flex;
            justify-content: center;
            gap: clamp(5px, 1vw, 10px);
            margin-bottom: clamp(8px, 1.5vw, 15px);
        }

        .period-btn {
            padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.5vw, 15px);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: var(--font-small);
        }

        .period-btn:hover, .period-btn.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        /* Settings Panel */
        .settings-btn {
            position: fixed;
            bottom: clamp(10px, 2vw, 20px);
            left: clamp(10px, 2vw, 20px);
            width: clamp(40px, 8vw, 50px);
            height: clamp(40px, 8vw, 50px);
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            font-size: clamp(1rem, 3vw, 1.5rem);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .settings-btn:hover {
            background: var(--accent-glow);
            transform: rotate(90deg);
        }

        .settings-panel {
            position: fixed;
            bottom: clamp(55px, 10vw, 80px);
            left: clamp(10px, 2vw, 20px);
            right: clamp(10px, 2vw, 20px);
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: clamp(12px, 2vw, 20px);
            border: 1px solid var(--border-color);
            display: none;
            max-width: 350px;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 10px 40px var(--shadow-color);
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel h3 {
            color: var(--accent-color);
            margin-bottom: clamp(10px, 2vw, 15px);
            font-size: var(--font-normal);
        }

        .settings-tabs {
            display: flex;
            gap: 3px;
            margin-bottom: clamp(10px, 2vw, 15px);
        }

        .settings-tab {
            flex: 1;
            padding: clamp(5px, 1vw, 8px);
            border: none;
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: clamp(0.6rem, 1.5vw, 0.8rem);
        }

        .settings-tab.active {
            background: var(--accent-color);
            color: #1a1a2e;
        }

        .settings-content {
            display: none;
        }

        .settings-content.active {
            display: block;
        }

        .setting-item {
            margin-bottom: clamp(10px, 2vw, 15px);
        }

        .setting-item label {
            display: block;
            margin-bottom: clamp(3px, 0.5vw, 5px);
            color: var(--text-muted);
            font-size: var(--font-small);
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: clamp(6px, 1.5vw, 10px);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: var(--font-small);
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .setting-row {
            display: flex;
            gap: clamp(5px, 1vw, 10px);
        }

        .setting-row .setting-item {
            flex: 1;
        }

        .btn-save {
            width: 100%;
            padding: clamp(8px, 1.5vw, 12px);
            background: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            margin-top: clamp(5px, 1vw, 10px);
            transition: all 0.3s ease;
            font-size: var(--font-small);
        }

        .btn-save:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #64ffda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* PWA Install Banner */
        .pwa-install-banner {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 1px solid var(--accent-color);
            display: none;
            z-index: 100;
            box-shadow: 0 10px 40px var(--shadow-color);
            max-width: 300px;
        }

        .pwa-install-banner.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pwa-install-banner h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .pwa-install-banner p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .pwa-buttons {
            display: flex;
            gap: 10px;
        }

        .pwa-buttons button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .pwa-install-btn {
            background: var(--accent-color);
            color: #1a1a2e;
        }

        .pwa-dismiss-btn {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 80px;
            z-index: 1001;
        }

        .toast {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-right: 4px solid #4caf50; }
        .toast.warning { border-right: 4px solid #ff9800; }
        .toast.error { border-right: 4px solid #f44336; }
        .toast.info { border-right: 4px solid #2196f3; }

        .toast-icon { font-size: 1.5rem; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: bold; font-size: 0.9rem; }
        .toast-message { font-size: 0.8rem; color: var(--text-muted); }

        /* Comparison Stats */
        .stats-comparison {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(5px, 1.5vw, 15px);
            margin-top: clamp(10px, 2vw, 20px);
        }

        @media (max-width: 600px) {
            .stats-comparison {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--chart-bg);
            border-radius: clamp(6px, 1.5vw, 10px);
            padding: clamp(8px, 1.5vw, 15px);
            text-align: center;
        }

        .stat-label {
            font-size: clamp(0.55rem, 1.3vw, 0.75rem);
            color: var(--text-muted);
            margin-bottom: clamp(3px, 0.5vw, 5px);
        }

        .stat-value {
            font-size: clamp(0.9rem, 2.5vw, 1.5rem);
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: clamp(0.55rem, 1.3vw, 0.75rem);
            margin-top: clamp(3px, 0.5vw, 5px);
        }

        .stat-change.positive { color: #f44336; }
        .stat-change.negative { color: #4caf50; }

        /* PWA Install Banner - Responsive */
        .pwa-install-banner {
            position: fixed;
            bottom: clamp(55px, 10vw, 80px);
            right: clamp(10px, 2vw, 20px);
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: clamp(10px, 2vw, 15px) clamp(12px, 2vw, 20px);
            border: 1px solid var(--accent-color);
            display: none;
            z-index: 100;
            box-shadow: 0 10px 40px var(--shadow-color);
            max-width: min(300px, 90vw);
        }

        .pwa-install-banner.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pwa-install-banner h4 {
            color: var(--accent-color);
            margin-bottom: clamp(6px, 1.5vw, 10px);
            font-size: var(--font-normal);
        }

        .pwa-install-banner p {
            font-size: var(--font-small);
            color: var(--text-muted);
            margin-bottom: clamp(10px, 2vw, 15px);
        }

        .pwa-buttons {
            display: flex;
            gap: clamp(5px, 1.5vw, 10px);
        }

        .pwa-buttons button {
            flex: 1;
            padding: clamp(5px, 1vw, 8px);
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: var(--font-small);
        }

        .pwa-install-btn {
            background: var(--accent-color);
            color: #1a1a2e;
        }

        .pwa-dismiss-btn {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        /* Toast Notifications - Responsive */
        .toast-container {
            position: fixed;
            bottom: clamp(10px, 2vw, 20px);
            right: clamp(55px, 10vw, 80px);
            z-index: 1001;
            max-width: min(350px, 80vw);
        }

        .toast {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: clamp(10px, 2vw, 15px) clamp(12px, 2vw, 20px);
            margin-bottom: clamp(5px, 1vw, 10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.5vw, 10px);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-right: 4px solid #4caf50; }
        .toast.warning { border-right: 4px solid #ff9800; }
        .toast.error { border-right: 4px solid #f44336; }
        .toast.info { border-right: 4px solid #2196f3; }

        .toast-icon { font-size: clamp(1rem, 3vw, 1.5rem); }
        .toast-content { flex: 1; }
        .toast-title { font-weight: bold; font-size: var(--font-small); }
        .toast-message { font-size: clamp(0.6rem, 1.3vw, 0.8rem); color: var(--text-muted); }

        /* Alert indicator responsive */
        .alert-indicator {
            position: absolute;
            top: clamp(5px, 1vw, 10px);
            left: clamp(5px, 1vw, 10px);
            font-size: clamp(1rem, 3vw, 1.5rem);
            display: none;
        }

        /* Hide some text on very small screens */
        @media (max-width: 400px) {
            .alerts-btn span:not(.alerts-badge):last-child {
                display: none;
            }
        }

        /* Fullscreen mode support */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        /* Landscape optimization */
        @media (orientation: landscape) and (max-height: 500px) {
            .gauge-container {
                --gauge-size: min(25vh, 150px);
            }
            .chart-wrapper {
                height: 40vh;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- SVG Gradients -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <linearGradient id="gasGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#ff6b6b"/>
                <stop offset="100%" style="stop-color:#ffa06b"/>
            </linearGradient>
            <linearGradient id="waterGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#4facfe"/>
                <stop offset="100%" style="stop-color:#00f2fe"/>
            </linearGradient>
            <linearGradient id="electricityGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#f9d423"/>
                <stop offset="100%" style="stop-color:#ff4e50"/>
            </linearGradient>
            <linearGradient id="temperatureGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#667eea"/>
                <stop offset="100%" style="stop-color:#764ba2"/>
            </linearGradient>
        </defs>
    </svg>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertBannerText">âš ï¸ ×”×ª×¨××”: ×—×¨×™×’×” ××™×¢×“ ×¦×¨×™×›×”!</span>
        <button class="close-alert" onclick="closeAlertBanner()">×¡×’×•×¨</button>
    </div>

    <!-- Alerts Panel -->
    <div class="alerts-panel" id="alertsPanel">
        <h3>ğŸ”” ×”×ª×¨××•×ª</h3>
        <div id="alertsList"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <h4>ğŸ“± ×”×ª×§×Ÿ ×›××¤×œ×™×§×¦×™×”</h4>
        <p>×”×•×¡×£ ××ª ×”×“×©×‘×•×¨×“ ×œ××¡×š ×”×‘×™×ª ×œ×’×™×©×” ××”×™×¨×” ×•×—×•×•×™×” ×˜×•×‘×” ×™×•×ª×¨</p>
        <div class="pwa-buttons">
            <button class="pwa-install-btn" onclick="installPWA()">×”×ª×§×Ÿ</button>
            <button class="pwa-dismiss-btn" onclick="dismissPWA()">×œ× ×¢×›×©×™×•</button>
        </div>
    </div>

    <div class="header">
        <h1>ğŸ  ×“×©×‘×•×¨×“ ×—×™×™×©× ×™ ×”×‘×™×ª</h1>
        <div class="datetime" id="datetime"></div>
        <div class="header-controls">
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionText">××—×•×‘×¨ ×œ-Tuya</span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="theme-icon" id="themeIcon">ğŸŒ™</span>
                <span id="themeText">××¦×‘ ×œ×™×œ×”</span>
            </button>
            <button class="alerts-btn" onclick="toggleAlerts()">
                ğŸ”” ×”×ª×¨××•×ª
                <span class="alerts-badge" id="alertsBadge">0</span>
            </button>
        </div>
    </div>

    <div class="dashboard">
        <!-- Gas Sensor -->
        <div class="sensor-card" id="gasCard">
            <span class="alert-indicator">âš ï¸</span>
            <div class="sensor-title">
                <span class="sensor-icon">ğŸ”¥</span>
                ×¦×¨×™×›×ª ×’×–
            </div>
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 100 100">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"/>
                    <circle class="gauge-progress gas" cx="50" cy="50" r="40" 
                            id="gasGauge"
                            stroke-dasharray="251.2"
                            stroke-dashoffset="251.2"/>
                </svg>
                <div class="gauge-center">
                    <div class="current-value" id="gasValue">0.0</div>
                    <div class="unit">mÂ³/×©×¢×”</div>
                </div>
            </div>
            <div class="history-section">
                <div class="history-title">×¡×”"×› ×”×—×•×“×©</div>
                <div class="history-value" id="gasMonthly">0 mÂ³</div>
                <div class="history-progress">
                    <div class="history-progress-bar gas" id="gasProgressBar" style="width: 0%"></div>
                </div>
                <div class="target-info">
                    <span>×™×¢×“: <span id="gasTarget">50</span> mÂ³</span>
                    <span id="gasPercent">0%</span>
                </div>
            </div>
            <div class="last-update">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="gasLastUpdate">--</span></div>
        </div>

        <!-- Water Sensor -->
        <div class="sensor-card" id="waterCard">
            <span class="alert-indicator">âš ï¸</span>
            <div class="sensor-title">
                <span class="sensor-icon">ğŸ’§</span>
                ×¦×¨×™×›×ª ××™×
            </div>
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 100 100">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"/>
                    <circle class="gauge-progress water" cx="50" cy="50" r="40"
                            id="waterGauge"
                            stroke-dasharray="251.2"
                            stroke-dashoffset="251.2"/>
                </svg>
                <div class="gauge-center">
                    <div class="current-value" id="waterValue">0.0</div>
                    <div class="unit">×œ×™×˜×¨/×“×§×”</div>
                </div>
            </div>
            <div class="history-section">
                <div class="history-title">×¡×”"×› ×”×—×•×“×©</div>
                <div class="history-value" id="waterMonthly">0 mÂ³</div>
                <div class="history-progress">
                    <div class="history-progress-bar water" id="waterProgressBar" style="width: 0%"></div>
                </div>
                <div class="target-info">
                    <span>×™×¢×“: <span id="waterTarget">15</span> mÂ³</span>
                    <span id="waterPercent">0%</span>
                </div>
            </div>
            <div class="last-update">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="waterLastUpdate">--</span></div>
        </div>

        <!-- Electricity Sensor -->
        <div class="sensor-card" id="electricityCard">
            <span class="alert-indicator">âš ï¸</span>
            <div class="sensor-title">
                <span class="sensor-icon">âš¡</span>
                ×¦×¨×™×›×ª ×—×©××œ
            </div>
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 100 100">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"/>
                    <circle class="gauge-progress electricity" cx="50" cy="50" r="40"
                            id="electricityGauge"
                            stroke-dasharray="251.2"
                            stroke-dashoffset="251.2"/>
                </svg>
                <div class="gauge-center">
                    <div class="current-value" id="electricityValue">0</div>
                    <div class="unit">×•×•××˜</div>
                </div>
            </div>
            <div class="history-section">
                <div class="history-title">×¡×”"×› ×”×—×•×“×©</div>
                <div class="history-value" id="electricityMonthly">0 kWh</div>
                <div class="history-progress">
                    <div class="history-progress-bar electricity" id="electricityProgressBar" style="width: 0%"></div>
                </div>
                <div class="target-info">
                    <span>×™×¢×“: <span id="electricityTarget">500</span> kWh</span>
                    <span id="electricityPercent">0%</span>
                </div>
            </div>
            <div class="last-update">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="electricityLastUpdate">--</span></div>
        </div>

        <!-- Water Heater Temperature -->
        <div class="sensor-card" id="temperatureCard">
            <span class="alert-indicator">âš ï¸</span>
            <div class="sensor-title">
                <span class="sensor-icon">ğŸŒ¡ï¸</span>
                ×˜××¤×¨×˜×•×¨×ª ×“×•×“ ××™×
            </div>
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 100 100">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"/>
                    <circle class="gauge-progress temperature" cx="50" cy="50" r="40"
                            id="temperatureGauge"
                            stroke-dasharray="251.2"
                            stroke-dashoffset="251.2"/>
                </svg>
                <div class="gauge-center">
                    <div class="current-value" id="temperatureValue">0</div>
                    <div class="unit">Â°C</div>
                </div>
            </div>
            <div class="history-section">
                <div class="history-title">×××•×¦×¢ ×™×•××™</div>
                <div class="history-value" id="temperatureAvg">0Â°C</div>
                <div class="history-progress">
                    <div class="history-progress-bar temperature" id="temperatureProgressBar" style="width: 0%"></div>
                </div>
                <div class="target-info">
                    <span>×˜×•×•×— ××•××œ×¥: 55-65Â°C</span>
                    <span id="temperatureStatus">×ª×§×™×Ÿ</span>
                </div>
            </div>
            <div class="last-update">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="temperatureLastUpdate">--</span></div>
        </div>
    </div>

    <!-- Advanced Charts Section -->
    <div class="charts-section">
        <h2>ğŸ“Š ×’×¨×¤×™× ×•×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
        
        <div class="chart-tabs">
            <button class="chart-tab active" onclick="switchChart('gas')">ğŸ”¥ ×’×–</button>
            <button class="chart-tab" onclick="switchChart('water')">ğŸ’§ ××™×</button>
            <button class="chart-tab" onclick="switchChart('electricity')">âš¡ ×—×©××œ</button>
            <button class="chart-tab" onclick="switchChart('temperature')">ğŸŒ¡ï¸ ×˜××¤×¨×˜×•×¨×”</button>
            <button class="chart-tab" onclick="switchChart('comparison')">ğŸ“ˆ ×”×©×•×•××”</button>
        </div>

        <div class="chart-period-selector">
            <button class="period-btn active" onclick="changePeriod(7)">7 ×™××™×</button>
            <button class="period-btn" onclick="changePeriod(14)">14 ×™××™×</button>
            <button class="period-btn" onclick="changePeriod(30)">30 ×™××™×</button>
        </div>

        <div class="chart-wrapper active" id="gasChartWrapper">
            <canvas id="gasChartCanvas"></canvas>
        </div>
        <div class="chart-wrapper" id="waterChartWrapper">
            <canvas id="waterChartCanvas"></canvas>
        </div>
        <div class="chart-wrapper" id="electricityChartWrapper">
            <canvas id="electricityChartCanvas"></canvas>
        </div>
        <div class="chart-wrapper" id="temperatureChartWrapper">
            <canvas id="temperatureChartCanvas"></canvas>
        </div>
        <div class="chart-wrapper" id="comparisonChartWrapper">
            <canvas id="comparisonChartCanvas"></canvas>
        </div>

        <!-- Statistics Comparison -->
        <div class="stats-comparison">
            <div class="stat-card">
                <div class="stat-label">×’×– - ×”×—×•×“×© vs ×§×•×“×</div>
                <div class="stat-value" id="gasCompare">--</div>
                <div class="stat-change" id="gasChange">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">××™× - ×”×—×•×“×© vs ×§×•×“×</div>
                <div class="stat-value" id="waterCompare">--</div>
                <div class="stat-change" id="waterChange">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">×—×©××œ - ×”×—×•×“×© vs ×§×•×“×</div>
                <div class="stat-value" id="electricityCompare">--</div>
                <div class="stat-change" id="electricityChange">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">×˜××¤×³ ×××•×¦×¢×ª</div>
                <div class="stat-value" id="tempCompare">--</div>
                <div class="stat-change" id="tempChange">--</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>××¢×¨×›×ª × ×™×˜×•×¨ ×—×™×™×©× ×™× ×—×›××™× | Tuya Smart Integration</p>
        <p style="margin-top: 5px;">×”× ×ª×•× ×™× × ×©××¨×™× ×‘××•×¤×Ÿ ××§×•××™ ×¢×œ ×”×˜××‘×œ×˜</p>
        <p style="margin-top: 5px; font-size: 0.8rem;">×’×¨×¡×” 2.0 | PWA Ready</p>
    </div>

    <!-- Settings Button -->
    <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <h3>âš™ï¸ ×”×’×“×¨×•×ª</h3>
        
        <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('tuya')">Tuya</button>
            <button class="settings-tab" onclick="switchSettingsTab('targets')">×™×¢×“×™×</button>
            <button class="settings-tab" onclick="switchSettingsTab('alerts')">×”×ª×¨××•×ª</button>
            <button class="settings-tab" onclick="switchSettingsTab('display')">×ª×¦×•×’×”</button>
        </div>

        <!-- Tuya Settings -->
        <div class="settings-content active" id="tuyaSettings">
            <div class="setting-item">
                <label>Access ID</label>
                <input type="text" id="tuyaAccessId" placeholder="×”×–×Ÿ Access ID">
            </div>
            <div class="setting-item">
                <label>Access Secret</label>
                <input type="password" id="tuyaAccessSecret" placeholder="×”×–×Ÿ Access Secret">
            </div>
            <div class="setting-item">
                <label>Device ID - ×’×–</label>
                <input type="text" id="gasDeviceId" placeholder="×”×–×Ÿ Device ID">
            </div>
            <div class="setting-item">
                <label>Device ID - ××™×</label>
                <input type="text" id="waterDeviceId" placeholder="×”×–×Ÿ Device ID">
            </div>
            <div class="setting-item">
                <label>Device ID - ×—×©××œ</label>
                <input type="text" id="electricityDeviceId" placeholder="×”×–×Ÿ Device ID">
            </div>
            <div class="setting-item">
                <label>Device ID - ×˜××¤×¨×˜×•×¨×”</label>
                <input type="text" id="temperatureDeviceId" placeholder="×”×–×Ÿ Device ID">
            </div>
        </div>

        <!-- Targets Settings -->
        <div class="settings-content" id="targetsSettings">
            <div class="setting-row">
                <div class="setting-item">
                    <label>×™×¢×“ ×’×– (mÂ³)</label>
                    <input type="number" id="gasTargetInput" value="50">
                </div>
                <div class="setting-item">
                    <label>×™×¢×“ ××™× (mÂ³)</label>
                    <input type="number" id="waterTargetInput" value="15">
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-item">
                    <label>×™×¢×“ ×—×©××œ (kWh)</label>
                    <input type="number" id="electricityTargetInput" value="500">
                </div>
                <div class="setting-item">
                    <label>×˜××¤×³ ××•××œ×¦×ª (Â°C)</label>
                    <input type="number" id="temperatureTargetInput" value="60">
                </div>
            </div>
        </div>

        <!-- Alerts Settings -->
        <div class="settings-content" id="alertsSettings">
            <div class="setting-item">
                <label>×”×ª×¨××” ×‘××—×•×– ××”×™×¢×“ (%)</label>
                <input type="number" id="alertThreshold" value="80" min="50" max="100">
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enableNotifications" checked>
                    ×”×¤×¢×œ ×”×ª×¨××•×ª Push
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enableSound" checked>
                    ×”×¤×¢×œ ×¦×œ×™×œ ×”×ª×¨××”
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enableTempAlert" checked>
                    ×”×ª×¨××” ×¢×œ ×˜××¤×¨×˜×•×¨×” ×—×¨×™×’×”
                </label>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="settings-content" id="displaySettings">
            <div class="setting-item">
                <label>×¢×¨×›×ª × ×•×©×</label>
                <select id="themeSelect">
                    <option value="auto">××•×˜×•××˜×™ (×œ×¤×™ ×©×¢×”)</option>
                    <option value="dark">×›×”×” ×ª××™×“</option>
                    <option value="light">×‘×”×™×¨ ×ª××™×“</option>
                </select>
            </div>
            <div class="setting-item">
                <label>×©×¢×ª ××¢×‘×¨ ×œ×œ×™×œ×”</label>
                <input type="time" id="nightStartTime" value="19:00">
            </div>
            <div class="setting-item">
                <label>×©×¢×ª ××¢×‘×¨ ×œ×™×•×</label>
                <input type="time" id="dayStartTime" value="06:00">
            </div>
            <div class="setting-item">
                <label>×§×¦×‘ ×¢×“×›×•×Ÿ (×©× ×™×•×ª)</label>
                <input type="number" id="updateInterval" value="5" min="1" max="60">
            </div>
        </div>

        <button class="btn-save" onclick="saveSettings()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
        <button class="btn-save btn-secondary" onclick="exportData()">ğŸ“¤ ×™×™×¦×•× × ×ª×•× ×™×</button>
        <button class="btn-save btn-danger" onclick="clearAlerts()">ğŸ—‘ï¸ × ×§×” ×”×ª×¨××•×ª</button>
    </div>

    <script>
        // ========================================
        // Configuration & State Management
        // ========================================
        
        const CONFIG = {
            UPDATE_INTERVAL: 5000,
            STORAGE_KEY: 'sensorDashboardData',
            SETTINGS_KEY: 'sensorDashboardSettings',
            ALERTS_KEY: 'sensorDashboardAlerts',
            TARGETS: {
                gas: 50,
                water: 15,
                electricity: 500,
                temperature: { min: 55, max: 65, optimal: 60 }
            },
            ALERT_THRESHOLD: 80, // Percentage
            THEME: {
                mode: 'auto',
                nightStart: '19:00',
                dayStart: '06:00'
            }
        };

        let sensorData = {
            gas: { current: 0, monthly: 0, daily: [], history: [] },
            water: { current: 0, monthly: 0, daily: [], history: [] },
            electricity: { current: 0, monthly: 0, daily: [], history: [] },
            temperature: { current: 0, average: 0, daily: [], history: [] }
        };

        let alerts = [];
        let charts = {};
        let deferredPrompt = null;
        let currentChartPeriod = 7;

        // ========================================
        // PWA Installation
        // ========================================
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install banner after 30 seconds
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwaDismissed')) {
                    document.getElementById('pwaInstallBanner').classList.add('active');
                }
            }, 30000);
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showToast('success', '×”×ª×§× ×” ×”×•×©×œ××”', '×”××¤×œ×™×§×¦×™×” × ×•×¡×¤×” ×œ××¡×š ×”×‘×™×ª');
                }
                deferredPrompt = null;
                document.getElementById('pwaInstallBanner').classList.remove('active');
            }
        }

        function dismissPWA() {
            document.getElementById('pwaInstallBanner').classList.remove('active');
            localStorage.setItem('pwaDismissed', 'true');
        }

        // ========================================
        // Theme Management (Day/Night Mode)
        // ========================================
        
        function applyTheme(theme) {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (theme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                icon.textContent = 'ğŸŒ™';
                text.textContent = '××¦×‘ ×œ×™×œ×”';
            } else {
                body.setAttribute('data-theme', 'light');
                icon.textContent = 'â˜€ï¸';
                text.textContent = '××¦×‘ ×™×•×';
            }
            
            // Update charts if they exist
            updateChartsTheme();
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            CONFIG.THEME.mode = newTheme;
            localStorage.setItem('themeMode', newTheme);
        }

        function checkAutoTheme() {
            if (CONFIG.THEME.mode !== 'auto') return;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [nightHour, nightMin] = CONFIG.THEME.nightStart.split(':').map(Number);
            const [dayHour, dayMin] = CONFIG.THEME.dayStart.split(':').map(Number);
            
            const nightTime = nightHour * 60 + nightMin;
            const dayTime = dayHour * 60 + dayMin;
            
            if (currentTime >= nightTime || currentTime < dayTime) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }

        function updateChartsTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6e6e6' : '#333';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.update();
                }
            });
        }

        // ========================================
        // Alert System
        // ========================================
        
        function checkAlerts() {
            const threshold = CONFIG.ALERT_THRESHOLD / 100;
            const newAlerts = [];
            
            // Gas alert
            const gasPercent = sensorData.gas.monthly / CONFIG.TARGETS.gas;
            if (gasPercent >= threshold) {
                const alertType = gasPercent >= 1 ? 'danger' : 'warning';
                newAlerts.push({
                    type: alertType,
                    sensor: 'gas',
                    title: '×¦×¨×™×›×ª ×’×–',
                    message: `×”×’×¢×ª ×œ-${(gasPercent * 100).toFixed(0)}% ××”×™×¢×“ ×”×—×•×“×©×™`,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('gasCard').classList.add(alertType);
            } else {
                document.getElementById('gasCard').classList.remove('warning', 'alert');
            }
            
            // Water alert
            const waterPercent = sensorData.water.monthly / CONFIG.TARGETS.water;
            if (waterPercent >= threshold) {
                const alertType = waterPercent >= 1 ? 'danger' : 'warning';
                newAlerts.push({
                    type: alertType,
                    sensor: 'water',
                    title: '×¦×¨×™×›×ª ××™×',
                    message: `×”×’×¢×ª ×œ-${(waterPercent * 100).toFixed(0)}% ××”×™×¢×“ ×”×—×•×“×©×™`,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('waterCard').classList.add(alertType);
            } else {
                document.getElementById('waterCard').classList.remove('warning', 'alert');
            }
            
            // Electricity alert
            const elecPercent = sensorData.electricity.monthly / CONFIG.TARGETS.electricity;
            if (elecPercent >= threshold) {
                const alertType = elecPercent >= 1 ? 'danger' : 'warning';
                newAlerts.push({
                    type: alertType,
                    sensor: 'electricity',
                    title: '×¦×¨×™×›×ª ×—×©××œ',
                    message: `×”×’×¢×ª ×œ-${(elecPercent * 100).toFixed(0)}% ××”×™×¢×“ ×”×—×•×“×©×™`,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('electricityCard').classList.add(alertType);
            } else {
                document.getElementById('electricityCard').classList.remove('warning', 'alert');
            }
            
            // Temperature alert
            const temp = sensorData.temperature.current;
            if (temp < CONFIG.TARGETS.temperature.min || temp > CONFIG.TARGETS.temperature.max) {
                const alertType = temp < 45 || temp > 75 ? 'danger' : 'warning';
                newAlerts.push({
                    type: alertType,
                    sensor: 'temperature',
                    title: '×˜××¤×¨×˜×•×¨×ª ×“×•×“',
                    message: temp < CONFIG.TARGETS.temperature.min ? 
                        `×”×˜××¤×¨×˜×•×¨×” × ××•×›×”: ${temp}Â°C` : 
                        `×”×˜××¤×¨×˜×•×¨×” ×’×‘×•×”×”: ${temp}Â°C`,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('temperatureCard').classList.add(alertType);
            } else {
                document.getElementById('temperatureCard').classList.remove('warning', 'alert');
            }
            
            // Process new alerts
            newAlerts.forEach(alert => {
                const exists = alerts.find(a => 
                    a.sensor === alert.sensor && 
                    a.type === alert.type &&
                    new Date(a.timestamp).getTime() > Date.now() - 3600000 // Within last hour
                );
                
                if (!exists) {
                    alerts.unshift(alert);
                    showToast(alert.type === 'danger' ? 'error' : 'warning', alert.title, alert.message);
                    
                    if (alert.type === 'danger') {
                        showAlertBanner(alert.message);
                        playAlertSound();
                    }
                }
            });
            
            // Keep only last 50 alerts
            alerts = alerts.slice(0, 50);
            
            // Update UI
            updateAlertsUI();
            saveAlerts();
        }

        function showAlertBanner(message) {
            const banner = document.getElementById('alertBanner');
            document.getElementById('alertBannerText').textContent = `âš ï¸ ×”×ª×¨××”: ${message}`;
            banner.classList.add('active');
        }

        function closeAlertBanner() {
            document.getElementById('alertBanner').classList.remove('active');
        }

        function updateAlertsUI() {
            const badge = document.getElementById('alertsBadge');
            const list = document.getElementById('alertsList');
            
            const activeAlerts = alerts.filter(a => 
                new Date(a.timestamp).getTime() > Date.now() - 86400000 // Last 24 hours
            );
            
            badge.textContent = activeAlerts.length;
            badge.classList.toggle('active', activeAlerts.length > 0);
            
            list.innerHTML = activeAlerts.length === 0 ? 
                '<p style="color: var(--text-muted); text-align: center;">××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª</p>' :
                activeAlerts.map(alert => `
                    <div class="alert-item ${alert.type}">
                        <strong>${alert.title}</strong>
                        <p>${alert.message}</p>
                        <div class="alert-time">${new Date(alert.timestamp).toLocaleString('he-IL')}</div>
                    </div>
                `).join('');
        }

        function toggleAlerts() {
            document.getElementById('alertsPanel').classList.toggle('active');
        }

        function clearAlerts() {
            alerts = [];
            updateAlertsUI();
            saveAlerts();
            showToast('success', '×”×ª×¨××•×ª × ×•×§×•', '×›×œ ×”×”×ª×¨××•×ª × ××—×§×•');
        }

        function playAlertSound() {
            if (!document.getElementById('enableSound')?.checked) return;
            
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            setTimeout(() => oscillator.stop(), 200);
        }

        function saveAlerts() {
            localStorage.setItem(CONFIG.ALERTS_KEY, JSON.stringify(alerts));
        }

        function loadAlerts() {
            try {
                const saved = localStorage.getItem(CONFIG.ALERTS_KEY);
                if (saved) alerts = JSON.parse(saved);
            } catch (e) {
                console.error('Error loading alerts:', e);
            }
        }

        // ========================================
        // Toast Notifications
        // ========================================
        
        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'ğŸš¨',
                info: 'â„¹ï¸'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ========================================
        // Advanced Charts (Chart.js)
        // ========================================
        
        function initCharts() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6e6e6' : '#333';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: textColor }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            };

            // Gas Chart
            charts.gas = new Chart(document.getElementById('gasChartCanvas'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '×¦×¨×™×›×ª ×’×– (mÂ³)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { ...defaultOptions }
            });

            // Water Chart
            charts.water = new Chart(document.getElementById('waterChartCanvas'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '×¦×¨×™×›×ª ××™× (mÂ³)',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { ...defaultOptions }
            });

            // Electricity Chart
            charts.electricity = new Chart(document.getElementById('electricityChartCanvas'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '×¦×¨×™×›×ª ×—×©××œ (kWh)',
                        data: [],
                        backgroundColor: 'rgba(249, 212, 35, 0.6)',
                        borderColor: '#f9d423',
                        borderWidth: 1
                    }]
                },
                options: { ...defaultOptions }
            });

            // Temperature Chart
            charts.temperature = new Chart(document.getElementById('temperatureChartCanvas'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '×˜××¤×¨×˜×•×¨×” (Â°C)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: '×˜×•×•×— ××•××œ×¥',
                        data: [],
                        borderColor: 'rgba(100, 255, 218, 0.5)',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: { ...defaultOptions }
            });

            // Comparison Chart
            charts.comparison = new Chart(document.getElementById('comparisonChartCanvas'), {
                type: 'radar',
                data: {
                    labels: ['×’×–', '××™×', '×—×©××œ', '×˜××¤×¨×˜×•×¨×”'],
                    datasets: [{
                        label: '×”×—×•×“×©',
                        data: [0, 0, 0, 0],
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        borderColor: '#ffd700',
                        pointBackgroundColor: '#ffd700'
                    }, {
                        label: '×™×¢×“',
                        data: [100, 100, 100, 100],
                        backgroundColor: 'rgba(100, 255, 218, 0.2)',
                        borderColor: '#64ffda',
                        pointBackgroundColor: '#64ffda'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                            pointLabels: { color: textColor }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const types = ['gas', 'water', 'electricity', 'temperature'];
            
            types.forEach(type => {
                if (!charts[type] || !sensorData[type].daily.length) return;
                
                const data = sensorData[type].daily.slice(-currentChartPeriod);
                charts[type].data.labels = data.map(d => d.day);
                charts[type].data.datasets[0].data = data.map(d => d.value.toFixed(2));
                
                // Add recommended range for temperature
                if (type === 'temperature') {
                    charts[type].data.datasets[1].data = data.map(() => CONFIG.TARGETS.temperature.optimal);
                }
                
                charts[type].update();
            });

            // Update comparison chart
            if (charts.comparison) {
                const gasPercent = (sensorData.gas.monthly / CONFIG.TARGETS.gas) * 100;
                const waterPercent = (sensorData.water.monthly / CONFIG.TARGETS.water) * 100;
                const elecPercent = (sensorData.electricity.monthly / CONFIG.TARGETS.electricity) * 100;
                const tempPercent = (sensorData.temperature.average / CONFIG.TARGETS.temperature.optimal) * 100;
                
                charts.comparison.data.datasets[0].data = [
                    Math.min(gasPercent, 150),
                    Math.min(waterPercent, 150),
                    Math.min(elecPercent, 150),
                    Math.min(tempPercent, 150)
                ];
                charts.comparison.update();
            }

            // Update statistics
            updateStatistics();
        }

        function updateStatistics() {
            // Simulated comparison with previous month
            const prevMonth = {
                gas: CONFIG.TARGETS.gas * 0.9,
                water: CONFIG.TARGETS.water * 0.85,
                electricity: CONFIG.TARGETS.electricity * 0.95
            };

            const gasChange = ((sensorData.gas.monthly - prevMonth.gas) / prevMonth.gas * 100).toFixed(1);
            const waterChange = ((sensorData.water.monthly - prevMonth.water) / prevMonth.water * 100).toFixed(1);
            const elecChange = ((sensorData.electricity.monthly - prevMonth.electricity) / prevMonth.electricity * 100).toFixed(1);

            document.getElementById('gasCompare').textContent = `${sensorData.gas.monthly} mÂ³`;
            document.getElementById('gasChange').textContent = `${gasChange > 0 ? '+' : ''}${gasChange}%`;
            document.getElementById('gasChange').className = `stat-change ${gasChange > 0 ? 'positive' : 'negative'}`;

            document.getElementById('waterCompare').textContent = `${sensorData.water.monthly} mÂ³`;
            document.getElementById('waterChange').textContent = `${waterChange > 0 ? '+' : ''}${waterChange}%`;
            document.getElementById('waterChange').className = `stat-change ${waterChange > 0 ? 'positive' : 'negative'}`;

            document.getElementById('electricityCompare').textContent = `${sensorData.electricity.monthly} kWh`;
            document.getElementById('electricityChange').textContent = `${elecChange > 0 ? '+' : ''}${elecChange}%`;
            document.getElementById('electricityChange').className = `stat-change ${elecChange > 0 ? 'positive' : 'negative'}`;

            document.getElementById('tempCompare').textContent = `${sensorData.temperature.average}Â°C`;
            const tempStatus = sensorData.temperature.average >= CONFIG.TARGETS.temperature.min && 
                              sensorData.temperature.average <= CONFIG.TARGETS.temperature.max ? '×ª×§×™×Ÿ' : '×—×¨×™×’';
            document.getElementById('tempChange').textContent = tempStatus;
            document.getElementById('tempChange').className = `stat-change ${tempStatus === '×ª×§×™×Ÿ' ? 'negative' : 'positive'}`;
        }

        function switchChart(type) {
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => wrapper.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${type}ChartWrapper`).classList.add('active');
        }

        function changePeriod(days) {
            currentChartPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCharts();
        }

        // ========================================
        // Data Management
        // ========================================
        
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (savedData) {
                    sensorData = JSON.parse(savedData);
                }
                
                const savedSettings = localStorage.getItem(CONFIG.SETTINGS_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    Object.assign(CONFIG, settings);
                    populateSettingsForm();
                }

                const savedTheme = localStorage.getItem('themeMode');
                if (savedTheme) {
                    CONFIG.THEME.mode = savedTheme;
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(sensorData));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        function saveSettings() {
            const settings = {
                TARGETS: {
                    gas: parseFloat(document.getElementById('gasTargetInput').value) || 50,
                    water: parseFloat(document.getElementById('waterTargetInput').value) || 15,
                    electricity: parseFloat(document.getElementById('electricityTargetInput').value) || 500,
                    temperature: CONFIG.TARGETS.temperature
                },
                ALERT_THRESHOLD: parseFloat(document.getElementById('alertThreshold').value) || 80,
                THEME: {
                    mode: document.getElementById('themeSelect').value,
                    nightStart: document.getElementById('nightStartTime').value,
                    dayStart: document.getElementById('dayStartTime').value
                },
                UPDATE_INTERVAL: (parseFloat(document.getElementById('updateInterval').value) || 5) * 1000,
                tuya: {
                    accessId: document.getElementById('tuyaAccessId').value,
                    accessSecret: document.getElementById('tuyaAccessSecret').value,
                    devices: {
                        gas: document.getElementById('gasDeviceId').value,
                        water: document.getElementById('waterDeviceId').value,
                        electricity: document.getElementById('electricityDeviceId').value,
                        temperature: document.getElementById('temperatureDeviceId').value
                    }
                }
            };
            
            Object.assign(CONFIG, settings);
            localStorage.setItem(CONFIG.SETTINGS_KEY, JSON.stringify(settings));
            
            // Update display
            document.getElementById('gasTarget').textContent = CONFIG.TARGETS.gas;
            document.getElementById('waterTarget').textContent = CONFIG.TARGETS.water;
            document.getElementById('electricityTarget').textContent = CONFIG.TARGETS.electricity;
            
            // Apply theme changes
            if (CONFIG.THEME.mode === 'auto') {
                checkAutoTheme();
            } else {
                applyTheme(CONFIG.THEME.mode);
            }
            
            showToast('success', '×”×’×“×¨×•×ª × ×©××¨×•', '×”×”×’×“×¨×•×ª ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”');
            toggleSettings();
        }

        function populateSettingsForm() {
            document.getElementById('gasTargetInput').value = CONFIG.TARGETS.gas;
            document.getElementById('waterTargetInput').value = CONFIG.TARGETS.water;
            document.getElementById('electricityTargetInput').value = CONFIG.TARGETS.electricity;
            document.getElementById('alertThreshold').value = CONFIG.ALERT_THRESHOLD;
            document.getElementById('themeSelect').value = CONFIG.THEME.mode;
            document.getElementById('nightStartTime').value = CONFIG.THEME.nightStart;
            document.getElementById('dayStartTime').value = CONFIG.THEME.dayStart;
            document.getElementById('updateInterval').value = CONFIG.UPDATE_INTERVAL / 1000;
            
            if (CONFIG.tuya) {
                document.getElementById('tuyaAccessId').value = CONFIG.tuya.accessId || '';
                document.getElementById('tuyaAccessSecret').value = CONFIG.tuya.accessSecret || '';
                document.getElementById('gasDeviceId').value = CONFIG.tuya.devices?.gas || '';
                document.getElementById('waterDeviceId').value = CONFIG.tuya.devices?.water || '';
                document.getElementById('electricityDeviceId').value = CONFIG.tuya.devices?.electricity || '';
                document.getElementById('temperatureDeviceId').value = CONFIG.tuya.devices?.temperature || '';
            }
        }

        function exportData() {
            const exportObj = {
                sensorData,
                alerts,
                settings: CONFIG,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sensor_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('success', '×™×™×¦×•× ×”×•×©×œ×', '×”× ×ª×•× ×™× ×™×•×¦××• ×‘×”×¦×œ×—×”');
        }

        // ========================================
        // UI Functions
        // ========================================
        
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function switchSettingsTab(tabName) {
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.settings-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}Settings`).classList.add('active');
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('he-IL', options);
        }

        function updateGauge(gaugeId, percentage) {
            const circumference = 251.2;
            const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;
            const gauge = document.getElementById(gaugeId);
            if (gauge) {
                gauge.style.strokeDashoffset = offset;
            }
        }

        function updateDisplay() {
            const timeStr = new Date().toLocaleTimeString('he-IL');

            // Gas
            document.getElementById('gasValue').textContent = sensorData.gas.current;
            document.getElementById('gasMonthly').textContent = `${sensorData.gas.monthly} mÂ³`;
            const gasPercent = Math.min(100, (sensorData.gas.monthly / CONFIG.TARGETS.gas) * 100);
            document.getElementById('gasProgressBar').style.width = `${gasPercent}%`;
            document.getElementById('gasPercent').textContent = `${gasPercent.toFixed(0)}%`;
            document.getElementById('gasLastUpdate').textContent = timeStr;
            updateGauge('gasGauge', gasPercent);

            // Water
            document.getElementById('waterValue').textContent = sensorData.water.current;
            document.getElementById('waterMonthly').textContent = `${sensorData.water.monthly} mÂ³`;
            const waterPercent = Math.min(100, (sensorData.water.monthly / CONFIG.TARGETS.water) * 100);
            document.getElementById('waterProgressBar').style.width = `${waterPercent}%`;
            document.getElementById('waterPercent').textContent = `${waterPercent.toFixed(0)}%`;
            document.getElementById('waterLastUpdate').textContent = timeStr;
            updateGauge('waterGauge', waterPercent);

            // Electricity
            document.getElementById('electricityValue').textContent = sensorData.electricity.current;
            document.getElementById('electricityMonthly').textContent = `${sensorData.electricity.monthly} kWh`;
            const elecPercent = Math.min(100, (sensorData.electricity.monthly / CONFIG.TARGETS.electricity) * 100);
            document.getElementById('electricityProgressBar').style.width = `${elecPercent}%`;
            document.getElementById('electricityPercent').textContent = `${elecPercent.toFixed(0)}%`;
            document.getElementById('electricityLastUpdate').textContent = timeStr;
            updateGauge('electricityGauge', elecPercent);

            // Temperature
            document.getElementById('temperatureValue').textContent = sensorData.temperature.current;
            document.getElementById('temperatureAvg').textContent = `${sensorData.temperature.average}Â°C`;
            const tempPercent = Math.min(100, (sensorData.temperature.current / 80) * 100);
            document.getElementById('temperatureProgressBar').style.width = `${tempPercent}%`;
            
            const temp = sensorData.temperature.current;
            let tempStatus = 'âœ… ×ª×§×™×Ÿ';
            if (temp < CONFIG.TARGETS.temperature.min) tempStatus = 'â„ï¸ ×§×¨';
            else if (temp > CONFIG.TARGETS.temperature.max) tempStatus = 'ğŸ”¥ ×—×';
            document.getElementById('temperatureStatus').textContent = tempStatus;
            document.getElementById('temperatureLastUpdate').textContent = timeStr;
            updateGauge('temperatureGauge', tempPercent);
        }

        // ========================================
        // Sensor Data Simulation
        // ========================================
        
        function simulateSensorData() {
            const now = new Date();
            const dayOfMonth = now.getDate();
            
            sensorData.gas.current = (Math.random() * 2).toFixed(2);
            sensorData.water.current = (Math.random() * 15).toFixed(1);
            sensorData.electricity.current = Math.floor(500 + Math.random() * 2500);
            sensorData.temperature.current = Math.floor(45 + Math.random() * 25);

            sensorData.gas.monthly = (dayOfMonth * 1.5 + Math.random() * 5).toFixed(1);
            sensorData.water.monthly = (dayOfMonth * 0.4 + Math.random() * 2).toFixed(2);
            sensorData.electricity.monthly = Math.floor(dayOfMonth * 15 + Math.random() * 50);
            sensorData.temperature.average = Math.floor(55 + Math.random() * 10);

            // Generate daily history
            const days = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
            if (sensorData.gas.daily.length < 30) {
                sensorData.gas.daily = [];
                sensorData.water.daily = [];
                sensorData.electricity.daily = [];
                sensorData.temperature.daily = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dayName = `${date.getDate()}/${date.getMonth() + 1}`;
                    
                    sensorData.gas.daily.push({ day: dayName, value: 1 + Math.random() * 3 });
                    sensorData.water.daily.push({ day: dayName, value: 0.3 + Math.random() * 0.8 });
                    sensorData.electricity.daily.push({ day: dayName, value: 10 + Math.random() * 25 });
                    sensorData.temperature.daily.push({ day: dayName, value: 50 + Math.random() * 15 });
                }
            }

            saveToStorage();
        }

        // ========================================
        // Initialization
        // ========================================
        
        function init() {
            console.log('ğŸš€ ×××ª×—×œ ×“×©×‘×•×¨×“ ×—×™×™×©× ×™× v2.0...');
            
            loadFromStorage();
            loadAlerts();
            
            // Apply initial theme
            if (CONFIG.THEME.mode === 'auto') {
                checkAutoTheme();
            } else {
                applyTheme(CONFIG.THEME.mode);
            }
            
            updateDateTime();
            simulateSensorData();
            updateDisplay();
            
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                initCharts();
                updateCharts();
            }, 100);
            
            checkAlerts();
            updateAlertsUI();
            
            // Set up intervals
            setInterval(updateDateTime, 1000);
            setInterval(() => {
                simulateSensorData();
                updateDisplay();
                checkAlerts();
            }, CONFIG.UPDATE_INTERVAL);
            
            setInterval(updateCharts, 60000);
            setInterval(checkAutoTheme, 60000);
            
            console.log('âœ… ×“×©×‘×•×¨×“ ××•×›×Ÿ!');
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);

        // ========================================
        // Service Worker Registration
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('âœ… Service Worker registered:', registration.scope);
                } catch (error) {
                    console.log('Service Worker registration skipped:', error.message);
                }
            });
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            setTimeout(() => {
                Notification.requestPermission();
            }, 5000);
        }
    </script>
</body>
</html>
